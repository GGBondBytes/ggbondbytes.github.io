<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>事件系统</title>
      <link href="/2023/07/28/%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F/"/>
      <url>/2023/07/28/%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="事件系统"><a href="#事件系统" class="headerlink" title="事件系统"></a>事件系统</h1><p>虚拟dom在内存中以<strong>对象</strong>的形式存在，基于虚拟dom，实现了<strong>SyntheticEvent（合成事件）</strong>层，与原生事件拥有相同的接口，同样支持事件冒泡，可使用<strong>stopPropagation(</strong>)和**preventDefault()**中断。</p><h2 id="SyntheticEvent的绑定方式"><a href="#SyntheticEvent的绑定方式" class="headerlink" title="SyntheticEvent的绑定方式"></a>SyntheticEvent的绑定方式</h2><ul><li>驼峰式命名法命名属性（html为全部小写）</li><li>props可以为任意属性（html只接收字符串）</li></ul><h2 id="SyntheticEvent的实现机制"><a href="#SyntheticEvent的实现机制" class="headerlink" title="SyntheticEvent的实现机制"></a>SyntheticEvent的实现机制</h2><h3 id="事件委派"><a href="#事件委派" class="headerlink" title="事件委派"></a>事件委派</h3><p>事件代理机制，将所有的时间绑定到最外层，使用一个统一的<strong>事件监听器</strong>管理映射，当组件挂载卸载时，只需要在事件监听器上新增或者删除一些对象。当事件发生时，事件监听器先处理找到实际的事件函数调用，简化了<strong>事件处理和回收机制，提升了效率。</strong></p><h3 id="事件绑定"><a href="#事件绑定" class="headerlink" title="事件绑定"></a>事件绑定</h3><ul><li><strong>bind方法</strong></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">btnClick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>无传参时可简化：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>btnClick<span class="token punctuation">&#125;</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><strong>构造器内绑定</strong></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">constructor<span class="token punctuation">&#123;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>btnClick<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">btnClick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><strong>箭头函数</strong></li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">btnClick</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">btnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token keyword">const</span> <span class="token function-variable function">btnClick</span><span class="token operator">=</span><span class="token parameter">e</span><span class="token operator">=></span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>btnClick<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用原生事件"><a href="#使用原生事件" class="headerlink" title="使用原生事件"></a>使用原生事件</h3><p>class组件在<strong>componentDidMount中绑定原生事件</strong>，但是需要注意的是，<strong>在使用原生事件时，要在componentWillUnmount中手动移除，防止内存泄漏</strong></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">&#123;</span>    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token parameter">e</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">btnClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token function">btnClick</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>refs<span class="token punctuation">.</span>button<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>            <span class="token operator">&lt;</span>button ref<span class="token operator">=</span><span class="token string">'button'</span><span class="token operator">></span>test<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="SyntheticEvent和原生事件混用"><a href="#SyntheticEvent和原生事件混用" class="headerlink" title="SyntheticEvent和原生事件混用"></a>SyntheticEvent和原生事件混用</h2><p>合成事件内部仅仅只是把最外层的容器进行了绑定，并依赖事件的冒泡机制完成事件委派。事件并不会绑定到真实的div上，所有使用stopProppagation没有用。</p><p><strong>解决方案：</strong></p><ol><li><strong>不要混用合成事件和原生事件</strong></li><li><strong>通过e?.target判断来避免</strong></li></ol><p>此外用reactEvent.nativeEvent.stopPropagation()来阻止冒泡是不行的，<strong>阻止react事件冒泡的行为只能用于react合成事件当中，且无法阻止dom原生事件；反之，在原生事件中阻止冒泡，可以阻止react合成事件冒泡</strong></p><p><strong>react的合成事件系统只是原生dom事件的子集。</strong>有些方法还是需要用原生的dom事件完成，比如window的resize事件。</p><h2 id="对比原生事件和合成事件"><a href="#对比原生事件和合成事件" class="headerlink" title="对比原生事件和合成事件"></a>对比原生事件和合成事件</h2><ul><li><strong>阻止事件传播与事件传播</strong></li></ul><p>react只实现了阻止事件传播。</p><p>原生的事件传播分为三个阶段：事件捕获阶段—-&gt;目标对象本身的事件程序处理程序调用—-&gt;事件冒泡。</p><ul><li><strong>事件类型</strong></li></ul><p>合成事件系统只是原生dom事件的子集。</p><ul><li><strong>事件绑定方式</strong></li></ul><p>直接在dom上绑定、在js中，通过为元素的事件属性赋值的方式(el.onclick&#x3D;e&#x3D;&gt;console.log(e))、通过事件监听函数（addEventListener(先绑定先执行)、attachEvent(IE,后绑定先执行)）</p><h2 id="受控组件和非受控组件"><a href="#受控组件和非受控组件" class="headerlink" title="受控组件和非受控组件"></a>受控组件和非受控组件</h2><p>尽量避免使用非受控组件</p><h1 id="组件之间通信"><a href="#组件之间通信" class="headerlink" title="组件之间通信"></a>组件之间通信</h1><h2 id="父子之间通信"><a href="#父子之间通信" class="headerlink" title="父子之间通信"></a>父子之间通信</h2><p>props</p><h2 id="子父之间通信"><a href="#子父之间通信" class="headerlink" title="子父之间通信"></a>子父之间通信</h2><p>回调函数</p><p>自定义事件机制</p><h2 id="跨级组件通信"><a href="#跨级组件通信" class="headerlink" title="跨级组件通信"></a>跨级组件通信</h2><p>context,慎用，一般建议全局信息且不会更改，例如主题，用户信息，防止不知道context从哪里传过来。</p><h2 id="无嵌套关系的组价之间"><a href="#无嵌套关系的组价之间" class="headerlink" title="无嵌套关系的组价之间"></a>无嵌套关系的组价之间</h2><p>自定义事件</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Pub&#x2F;Sub模式的实现简单，即用全局对象保存事件、用广播的方式处理事件，缺点是逻辑混乱。应当避免使用，加入强依赖和约定是更好的方法</p><h1 id="组件间抽象"><a href="#组件间抽象" class="headerlink" title="组件间抽象"></a>组件间抽象</h1><h2 id="mixin"><a href="#mixin" class="headerlink" title="mixin"></a>mixin</h2><h3 id="引入minin的目的"><a href="#引入minin的目的" class="headerlink" title="引入minin的目的"></a>引入minin的目的</h3><p>早期是为了为了创造一种类似多继承的效果。知道es6引入class才向着标准化靠拢。</p><h3 id="封装minin"><a href="#封装minin" class="headerlink" title="封装minin"></a>封装minin</h3><p>广义的mixin方法，就是用赋值的方式将mixin对象里面的方法挂载到原对象上面，来实现对对象的混入。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span>mixins</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>  <span class="token keyword">const</span> newObj<span class="token operator">=</span>obj<span class="token punctuation">;</span>  newObj<span class="token punctuation">.</span>prototype<span class="token operator">=</span>Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> mixinsKey <span class="token keyword">in</span> mixins<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mixins<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>mixinsKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      newObj<span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>mixinsKey<span class="token punctuation">]</span><span class="token operator">=</span>mixins<span class="token punctuation">[</span>mixinsKey<span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="react中使用mixin"><a href="#react中使用mixin" class="headerlink" title="react中使用mixin"></a>react中使用mixin</h3><p>react在使用createClass构建组件时提供了mixin属性。比如<strong>PureRenderMixin:</strong></p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>impotr PureRenderMixin <span class="token keyword">from</span> <span class="token string">'react-addons-pure-render-mixin'</span><span class="token punctuation">;</span>React<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>  <span class="token literal-property property">mixin</span><span class="token operator">:</span><span class="token punctuation">[</span>PureRenderMixin<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>div<span class="token operator">></span>aaa<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>  <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>mixin数组可增加多个mixin,<strong>在不同的mixin实现两个相同的如同方法，后面的方法不会覆盖前面的方法，但是会报ReactClassInterface里面的错。因此，在React中不允许出现重名方法的mixin。</strong></p><p><strong>使用ReactClass实现mixin为组件做了两件事：</strong></p><ul><li>共享一些工具方法</li><li>生命周期的继承，props和state合并。</li></ul><h3 id="mixin缺点"><a href="#mixin缺点" class="headerlink" title="mixin缺点"></a>mixin缺点</h3><ul><li>破坏了组件原有的封装</li><li>命名冲突</li><li>增加复杂性</li></ul><h1 id="高阶组件"><a href="#高阶组件" class="headerlink" title="高阶组件"></a>高阶组件</h1><h2 id="属性代理"><a href="#属性代理" class="headerlink" title="属性代理"></a>属性代理</h2><p><strong>通过高阶组件来传递props，即为属性代理</strong></p><p>使用属性代理时，不同于mixin，类似于<strong>堆栈调用：</strong></p><p><strong>didmount-&gt;HOC didmount-&gt;(HOCs didmount)-&gt;(HOCs will unmount)-&gt;HOC willunmount-&gt;unmount</strong></p><p>功能：</p><ul><li>控制props</li></ul><p>可以增加，移除，编辑传进来的props，<strong>应尽可能对高阶组件的props做新的命名。</strong></p><ul><li>通过refs使用引用</li><li>抽象state</li></ul><p>高阶组件可以将原组件抽象为展示型组件，分离内部状态</p><ul><li>使用其他元素包裹组件</li></ul><p><strong>HOC与mixin不同：</strong></p><p><strong>高阶组件符合函数式编程的，对于原组件来说，并不会感知到高阶组件的存在，只需要把功能套在其之上，避免了使用mixin时产生的副作用。</strong></p><p><img src="/2023/07/28/%E4%BA%8B%E4%BB%B6%E7%B3%BB%E7%BB%9F/mixin.png"></p><h2 id="反向继承"><a href="#反向继承" class="headerlink" title="反向继承"></a>反向继承</h2><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">Test</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">InputComponent</span><span class="token punctuation">)</span><span class="token operator">=></span>  <span class="token keyword">class</span> <span class="token class-name">extends</span> InputComponent<span class="token punctuation">&#123;</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如上，高阶组件的返回组件继承于InputComponent，因此被动的继承了InputComponent。方法可以通过super来调用，调用顺序与队列一致：</p><p><strong>didmount-&gt;HOC didmount-&gt;(HOCs didmount)-&gt;will unmount-&gt;HOC will unmount-&gt;(HOCs willunmount)</strong></p><ul><li><strong>渲染劫持</strong></li></ul>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
            <tag> JavaScript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>debouncePromise</title>
      <link href="/2022/07/14/debouncePromise/"/>
      <url>/2022/07/14/debouncePromise/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 中断当前promise</span><span class="token keyword">function</span> <span class="token function">abortPromise</span><span class="token punctuation">(</span><span class="token parameter">promise1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> abort<span class="token punctuation">;</span>  <span class="token keyword">const</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    abort <span class="token operator">=</span> reject<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>promise1<span class="token punctuation">,</span> promise2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  p<span class="token punctuation">.</span>abort <span class="token operator">=</span> abort<span class="token punctuation">;</span>  <span class="token keyword">return</span> p<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// promise防抖</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">debouncePromise</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> time</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">let</span> promise<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>rest</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> promise<span class="token punctuation">.</span>abort <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      promise<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">const</span> timeoutPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    promise <span class="token operator">=</span> <span class="token function">abortPromise</span><span class="token punctuation">(</span>timeoutPromise<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>rest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
